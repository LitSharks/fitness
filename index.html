<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fitness Coaching Program</title>
  <style>
    /* Basic styling */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header { background: #333; color: #fff; padding: 1em; }
    header nav a { color: #fff; text-decoration: none; margin-right: 1em; font-weight: bold; cursor: pointer; }
    .tab-content { display: none; padding: 1em; }
    .tab-content.active { display: block; }
    .info-box { position: fixed; right: 0; top: 60px; background: #f9f9f9; border-left: 2px solid #ccc; padding: 1em; width: 300px; max-height: 80%; overflow-y: auto; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    .login-form { max-width: 300px; margin: 1em auto; border: 1px solid #ccc; padding: 1em; border-radius: 5px; }
    .login-form input { width: 100%; padding: 0.5em; margin-bottom: 1em; }
    .admin-panel { padding: 1em; background: #efefef; margin-bottom: 1em; }
    .hidden { display: none; }
    /* Log styling */
    #log {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #eee;
      color: #333;
      font-size: 12px;
      max-height: 200px;
      overflow-y: scroll;
      padding: 10px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <!-- These tabs are hidden until login -->
      <a data-tab="training" class="tab-link" id="navTraining" style="display:none;">Training Plan</a>
      <a data-tab="tutorials" class="tab-link" id="navTutorials" style="display:none;">Tutorials</a>
      <!-- Login is visible initially -->
      <a data-tab="login" class="tab-link" id="navLogin">Login</a>
      <!-- Admin control is hidden until an admin logs in -->
      <a data-tab="admin" class="tab-link" id="navAdmin" style="display:none;">Admin Control</a>
      <a id="logoutLink" style="display:none; cursor:pointer; color:#fff; margin-left:1em;">Logout</a>
    </nav>
  </header>

  <!-- Training Plan Tab -->
  <div id="training" class="tab-content">
    <h2>Stamina Training Plan - 5 Weeks</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Week</th>
            <th>M</th>
            <th>TU</th>
            <th>W</th>
            <th>TH</th>
            <th>F</th>
            <th>SA</th>
            <th>SU</th>
          </tr>
        </thead>
        <tbody id="trainingTableBody">
          <!-- Default training plan row -->
          <tr>
            <td>T1</td>
            <td>Off</td>
            <td>10-15 min w-up<br>30 sec sprint (70-80%)<br>to 60 sec walk<br>(4-12 times)</td>
            <td>10-15 min c-d<br>X-train or 20-25 min EZ</td>
            <td>10-15 min w-up<br>30-40 min Tempo run<br>(80–85% effort)</td>
            <td>-10-15 min c-d<br>X-train or 20-25 min EZ</td>
            <td>Off</td>
            <td>45-55 min Long Run</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="info-box">
      <h3>Notes</h3>
      <p><strong>X-train</strong> (cross train) means to do something other than running but still targets the legs (e.g., biking, swimming, etc.).</p>
      <p>On Hard days train Hard and on EZ days train Easy.</p>
      <p>Eat well &amp; Sleep well (7-9 hours).</p>
      <p>Ask if you want alternative workouts (e.g., Strength-endurance: calisthenics + weights).</p>
    </div>
  </div>

  <!-- Tutorials Tab -->
  <div id="tutorials" class="tab-content">
    <h2>Tutorials</h2>
    <ul id="tutorialList">
      <li><a href="https://www.youtube.com/watch?v=k5vqiyry2z8" target="_blank">Tempo Run</a></li>
      <li><a href="https://www.youtube.com/watch?v=L_vZjikr5Ew" target="_blank">Breathing Easier</a></li>
      <li><a href="https://www.youtube.com/watch?v=Z3crT2UBeJE" target="_blank">Fartlek Run</a></li>
      <li><a href="https://www.youtube.com/watch?v=5B1LxT_6GW0" target="_blank">Long Run</a></li>
      <li><a href="https://www.youtube.com/shorts/s14SzolOHDY" target="_blank">Strides</a></li>
    </ul>
  </div>

  <!-- Login Tab -->
  <div id="login" class="tab-content active">
    <h2>User Login</h2>
    <div class="login-form" id="loginForm">
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <button id="loginBtn">Login</button>
    </div>
    <div id="userContent" style="display:none;">
      <h3>Welcome, <span id="loggedInUser"></span>!</h3>
      <h4>Your Training Plan</h4>
      <p id="userTraining"></p>
      <h4>Your Tutorials</h4>
      <p id="userTutorials"></p>
    </div>
  </div>

  <!-- Admin Control Tab -->
  <div id="admin" class="tab-content">
    <h2>Admin Control Panel</h2>
    <div class="admin-panel">
      <button id="loadUsers">Load Users</button>
      <div id="userList"></div>
      <h3>Add New User</h3>
      <input type="text" id="newUsername" placeholder="New Username" />
      <input type="text" id="newPassword" placeholder="New Password" />
      <button id="addUser">Add User</button>
    </div>
    <!-- User Editing Page (hidden by default) -->
    <div id="editUser" style="display:none;">
      <h3>Edit User: <span id="editUsernameDisplay"></span></h3>
      <input type="text" id="editUsername" placeholder="Username" /><br>
      <input type="text" id="editPassword" placeholder="Password" /><br>
      <h4>Training Plan</h4>
      <textarea id="editTraining" rows="6" cols="50"></textarea><br>
      <h4>Tutorials</h4>
      <textarea id="editTutorials" rows="6" cols="50"></textarea><br>
      <button id="saveEdit">Save Changes</button>
      <button id="cancelEdit">Cancel</button>
    </div>
  </div>

  <!-- Log Output Area -->
  <div id="log"></div>

  <!-- Include a browser-friendly version of jsrsasign -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.23/jsrsasign-all-min.js"></script>
  <script>
    // Simple logging function to output messages to the log div
    function logMessage(message) {
      const logDiv = document.getElementById("log");
      const msgDiv = document.createElement("div");
      msgDiv.textContent = message;
      logDiv.appendChild(msgDiv);
    }

    /********************
     * Google Sheets API Setup
     ********************/
    const SERVICE_ACCOUNT_EMAIL = "service-account@fitness-coaching-api.iam.gserviceaccount.com";
    const PRIVATE_KEY = `-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCs4H5Hh6v2tsqo
Z6MxKPprhhJr9TTCyvS/H+fL/Az4ngOAxEK0h054osWUa5lUzU7MZUFAszLmUiJZ
qR+AKXqLtCtvbaGiRO7vyvI6zg+8JU3LdyKDxaYoJqD+/ZBI7vN+SCjxWla5V/bG
psJKpMXyTyXMn8hqMxyzQ696LZ1rAiSR1AWosslfw2TCFFzDmZeqH8H3c4G1FZIJ
dYt9+cGZYN7R2bhDWL2aRlXMJJXuC39P8zGojXVdZ+fKv1eiG/fhSRW6ddEJTror
NsCNwIyQnpx1IQkq4lMMsgsOkwSNp56QtLVeTRkvtqsymBdF2fGWtCK+LWsXbIgj
+BribK+NAgMBAAECggEAEQXRAW+fU/2XUoJT/Cr+D5jl1voP7i9obqpwW3Jv/4ol
q6gHrnmVVUUn4e+/ay2FORSuWnXayPmk9sGzv521+qwsy73WmOEjSvrno7k3LO5a
bPLH9ARCEnmNSFaE/t2CnfhyiaN83ybFfrWcc5eqgyvee7nvFOAADznWvVfhBJCJ
qEHV93niS4bHyO42S/dfwJCB9bH0LNuuDwkBo4ucAYzkltATDZdBtFFIH3KLuzgr
Wv99PhJnVxoakrXqHkIyS638m+c1fqztYm2icHkgPFYbLSW3KOWBoU41iGLNioS6
wkB47mAH0W+krRUHM5RXcaRW/7Uus7kXELmlJfCK6QKBgQDiotyiGvDXxhRBTyZv
LJOZNJJ5Ux3mqiSS2HAB5B2B8Yeum1K4KxyqcYOC6JQioqNkH/WBX3vlWcGTATbx
YfgQX6WU7YCByX/CrJ5QChll/YLFIz6mLyjPyPWbt32CiDSSU6AQi4NLaXCJOhlN
4ihkohj3s+jrXoEfHfKZjYGFiQKBgQDDRocxhIAme+EM/MXK/Zzt7d7TCElF/3Pp
MiZO0WsMZ9rZU+LzX7evP1+aCvCc9RGplgIkVl8/66G+DIGNoEIID3y23Xzs31WT
C8o4eelP1TcN3apmczGpeWViuzUgsrydV4+iGiVnaFZLMtn/Fpz4jQlYhRGObwhb
nMxvYztc5QKBgQDAJCc93+1UYgCGJh6Fnps8BlAwQAFXr+P2Az1ivQ0vP6AyrkiB
DzvsXPSMJbaBbrVri5TOrC8UEPaGNT9pgg+Xgh+VlY2fez+vwj0tyoIh773QeMMC
jXTiRJPGAtiLtAIuFGvd2wnjA29/SBxv5U8tkifsyUCtW5/Iy9ED0e5/UQKBgQCp
lpLKulvhECy+7reINwEW0UJ22/dmxxePKnKCePUS7Q7vNx8eZb5MgCkyytV0OpGA
SjrJ/Aj0plrthkbtDITMI0cYOPrJbJwQ/Gg+7AFnx6/sZtoZ52j12evm9taI8zFD
JEwlZ7ecOszWue8Azk68vR+ktMwuetczWNVi1zcy0QKBgCv30zzEtv/uEmW4Uh1d
rsRAnMW53Sx9dpLRu60PFGYO43Dq/CrBDwbbrCjHUNB1l6jaz2IBKHE6s/s3fXjt
6WxeGq4ufJup8vQrIn0l6F/OYxB118Z2G4Iz9F87jcUM6PYOfUwJt1g9CuUmzmSH
7/TjHERfIzWM9qI+/ha6ZlIy
-----END PRIVATE KEY-----\n`;
    const TOKEN_URL = "https://oauth2.googleapis.com/token";
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
    const SPREADSHEET_ID = "1aHnKAI9lNw8-ewOjwKV9XAwt8u10qU2C_OTFSoJCwe8";
    // Use a fixed range ending row for users data
    const USERS_RANGE = "Users!A2:D1000";
    // The sheetId for the "Users" tab – update if needed (gid from URL)
    const USERS_SHEET_ID = 0; 

    // Global storage for loaded user data from the sheet
    let allUsers = [];
    // Store the currently logged-in user (object from allUsers)
    let currentUser = null;
    // For editing a user in admin panel
    let currentEditRow = null;

    // Function to get an access token using the service account
    async function getAccessToken() {
      try {
        const header = { alg: "RS256", typ: "JWT" };
        const now = Math.floor(Date.now() / 1000);
        const claims = {
          iss: SERVICE_ACCOUNT_EMAIL,
          scope: SCOPES,
          aud: TOKEN_URL,
          iat: now,
          exp: now + 3600
        };
        const sHeader = JSON.stringify(header);
        const sPayload = JSON.stringify(claims);
        const privateKey = KEYUTIL.getKey(PRIVATE_KEY);
        const sJWT = KJUR.jws.JWS.sign("RS256", sHeader, sPayload, privateKey);
        const formData = new URLSearchParams();
        formData.append("grant_type", "urn:ietf:params:oauth:grant-type:jwt-bearer");
        formData.append("assertion", sJWT);
        logMessage("Requesting access token...");
        const response = await fetch(TOKEN_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData.toString()
        });
        const data = await response.json();
        logMessage("Access token received.");
        return data.access_token;
      } catch (e) {
        logMessage("Error in getAccessToken: " + e.message);
        throw e;
      }
    }

    /********************
     * Sheet Data Functions
     ********************/
    // Load all users from the sheet and store in allUsers[]
    async function loadUsers() {
      try {
        const token = await getAccessToken();
        // Use the range directly without encoding
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${USERS_RANGE}`;
        logMessage("Fetching users data from: " + url);
        const response = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
        logMessage("Response status: " + response.status);
        const data = await response.json();
        logMessage("Users data received: " + JSON.stringify(data));
        allUsers = [];
        if (data.values) {
          data.values.forEach((row, index) => {
            allUsers.push({
              row: index + 2, // since data starts on row 2
              username: row[0],
              password: row[1],
              training: row[2] || "",
              tutorials: row[3] || ""
            });
          });
        }
      } catch (e) {
        logMessage("Error in loadUsers: " + e.message);
      }
    }

    // Update a user in the sheet at a given row
    async function updateUser(row, userObj) {
      try {
        const token = await getAccessToken();
        const range = `Users!A${row}:D${row}`;
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=USER_ENTERED`;
        const body = JSON.stringify({
          values: [[userObj.username, userObj.password, userObj.training, userObj.tutorials]]
        });
        logMessage("Updating user at row " + row);
        const response = await fetch(url, {
          method: "PUT",
          headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
          body: body
        });
        const result = await response.json();
        logMessage("Update result: " + JSON.stringify(result));
        return result;
      } catch (e) {
        logMessage("Error in updateUser: " + e.message);
      }
    }

    // Append a new user to the sheet
    async function appendUser(userObj) {
      try {
        const token = await getAccessToken();
        const range = "Users!A:D";
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
        const body = JSON.stringify({
          values: [[userObj.username, userObj.password, userObj.training, userObj.tutorials]]
        });
        logMessage("Appending new user: " + userObj.username);
        const response = await fetch(url, {
          method: "POST",
          headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
          body: body
        });
        const result = await response.json();
        logMessage("Append result: " + JSON.stringify(result));
        return result;
      } catch (e) {
        logMessage("Error in appendUser: " + e.message);
      }
    }

    // Delete a user (row) using batchUpdate
    async function deleteUserRow(row) {
      try {
        const token = await getAccessToken();
        const rowIndex = row - 1; // Convert sheet row number to 0-indexed
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}:batchUpdate`;
        const body = JSON.stringify({
          requests: [
            {
              deleteDimension: {
                range: {
                  sheetId: USERS_SHEET_ID,
                  dimension: "ROWS",
                  startIndex: rowIndex,
                  endIndex: rowIndex + 1
                }
              }
            }
          ]
        });
        logMessage("Deleting user at row " + row);
        const response = await fetch(url, {
          method: "POST",
          headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
          body: body
        });
        const result = await response.json();
        logMessage("Delete result: " + JSON.stringify(result));
        return result;
      } catch (e) {
        logMessage("Error in deleteUserRow: " + e.message);
      }
    }

    /********************
     * UI and Login Functions
     ********************/
    // Tab switching logic
    document.querySelectorAll('.tab-link').forEach(link => {
      link.addEventListener('click', () => {
        const tabId = link.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
      });
    });

    // Login functionality: load users from sheet then verify credentials
    document.getElementById('loginBtn').addEventListener('click', async () => {
      await loadUsers();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const user = allUsers.find(u => u.username === username && u.password === password);
      if (user) {
        currentUser = user;
        alert('Login successful!');
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('userContent').style.display = 'block';
        document.getElementById('loggedInUser').textContent = username;
        document.getElementById('userTraining').textContent = user.training || "No training plan set.";
        document.getElementById('userTutorials').textContent = user.tutorials || "No tutorials set.";
        document.getElementById('navTraining').style.display = 'inline';
        document.getElementById('navTutorials').style.display = 'inline';
        document.getElementById('navLogin').style.display = 'none';
        document.getElementById('logoutLink').style.display = 'inline';
        if (username === 'cardio') {
          document.getElementById('navAdmin').style.display = 'inline';
        }
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById('training').classList.add('active');
      } else {
        alert('Invalid username or password.');
        logMessage("Login failed for username: " + username);
      }
    });

    // Logout functionality
    document.getElementById('logoutLink').addEventListener('click', () => {
      currentUser = null;
      document.getElementById('navTraining').style.display = 'none';
      document.getElementById('navTutorials').style.display = 'none';
      document.getElementById('navAdmin').style.display = 'none';
      document.getElementById('navLogin').style.display = 'inline';
      document.getElementById('logoutLink').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('userContent').style.display = 'none';
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById('login').classList.add('active');
      logMessage("User logged out.");
    });

    /********************
     * Admin Panel Functions
     ********************/
    // Load users into admin panel list
    document.getElementById('loadUsers').addEventListener('click', async () => {
      await loadUsers();
      let output = '<ul>';
      allUsers.forEach(u => {
        output += `<li>${u.username} - ${u.password} 
          <button onclick="editUser(${u.row})">Edit</button> 
          <button onclick="deleteUser(${u.row})">Delete</button></li>`;
      });
      output += '</ul>';
      document.getElementById('userList').innerHTML = output;
      logMessage("Admin panel loaded users.");
    });

    // Add a new user via admin panel
    document.getElementById('addUser').addEventListener('click', async () => {
      const newUsername = document.getElementById('newUsername').value;
      const newPassword = document.getElementById('newPassword').value;
      if(newUsername && newPassword){
        const newUser = { username: newUsername, password: newPassword, training: "Default training plan.", tutorials: "Default tutorials." };
        await appendUser(newUser);
        alert('User added.');
        document.getElementById('newUsername').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('loadUsers').click();
      } else {
        alert('Please enter both username and password.');
        logMessage("Failed to add user; missing username or password.");
      }
    });

    // Delete a user via admin panel
    async function deleteUser(row) {
      if (confirm("Are you sure you want to delete this user?")) {
        await deleteUserRow(row);
        alert("User deleted.");
        document.getElementById('loadUsers').click();
      }
    }

    // Edit a user: load their data into the edit form
    function editUser(row) {
      const user = allUsers.find(u => u.row === row);
      if (user) {
        currentEditRow = row;
        document.getElementById('editUser').style.display = 'block';
        document.getElementById('editUsernameDisplay').textContent = user.username;
        document.getElementById('editUsername').value = user.username;
        document.getElementById('editPassword').value = user.password;
        document.getElementById('editTraining').value = user.training;
        document.getElementById('editTutorials').value = user.tutorials;
        logMessage("Editing user: " + user.username);
      }
    }

    // Save edited user data via admin panel
    document.getElementById('saveEdit').addEventListener('click', async () => {
      const newUsername = document.getElementById('editUsername').value;
      const newPassword = document.getElementById('editPassword').value;
      const newTraining = document.getElementById('editTraining').value;
      const newTutorials = document.getElementById('editTutorials').value;
      if(newUsername && newPassword){
        const updatedUser = {
          username: newUsername,
          password: newPassword,
          training: newTraining,
          tutorials: newTutorials
        };
        await updateUser(currentEditRow, updatedUser);
        alert("User updated.");
        document.getElementById('editUser').style.display = 'none';
        document.getElementById('loadUsers').click();
      } else {
        alert("Please fill in all fields.");
        logMessage("Failed to save edit; missing fields.");
      }
    });

    document.getElementById('cancelEdit').addEventListener('click', () => {
      document.getElementById('editUser').style.display = 'none';
      logMessage("Edit canceled.");
    });
  </script>
</body>
</html>
