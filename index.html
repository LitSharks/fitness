<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fitness Coaching Program</title>
  <!-- CKEditor 5 Classic for admin editing -->
  <script src="https://cdn.ckeditor.com/ckeditor5/35.0.1/classic/ckeditor.js"></script>
  <style>
    /* Global Styles for modern, minimalistic feel */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
      color: #333;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
      background: #222;
      color: #ddd;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #222;
      color: #fff;
      padding: 1em;
    }
    header nav {
      display: flex;
      align-items: center;
    }
    header nav a {
      color: #fff;
      text-decoration: none;
      margin-right: 1em;
      font-weight: 600;
      cursor: pointer;
    }
    header .header-right {
      display: flex;
      align-items: center;
    }
    header img.logo {
      height: 80px; /* enlarged logo */
      margin-right: 1em;
    }
    header button.settings-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .settings-popover {
      position: absolute;
      top: 60px;
      right: 20px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 1em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: none;
      z-index: 100;
    }
    .settings-popover label {
      color: #333;
    }
    body.dark-mode .settings-popover {
      background: #333;
      border-color: #444;
    }
    body.dark-mode .settings-popover label {
      color: #ddd;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #66bb6a;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    /* Tab Content Styling */
    .tab-content {
      display: none;
      padding: 1.5em;
      background: #fff;
      margin: 1em auto;
      max-width: 900px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 5px;
      transition: background 0.3s, color 0.3s;
    }
    .tab-content.active {
      display: block;
    }
    body.dark-mode .tab-content {
      background: #333;
      color: #ddd;
    }
    .login-form {
      max-width: 300px;
      margin: 1em auto;
      padding: 1em;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 5px;
    }
    body.dark-mode .login-form {
      background: #444;
      border-color: #666;
    }
    .login-form input {
      width: 100%;
      padding: 0.5em;
      margin-bottom: 1em;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .admin-panel {
      padding: 1em;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 1em;
    }
    body.dark-mode .admin-panel {
      background: #444;
      border-color: #666;
    }
    /* Ensure tables display borders */
    #displayTraining table,
    #displayTraining th,
    #displayTraining td,
    #displayTutorials table,
    #displayTutorials th,
    #displayTutorials td {
      border: 1px solid #ddd !important;
      border-collapse: collapse;
    }
    #displayTraining th,
    #displayTutorials th,
    #displayTraining td,
    #displayTutorials td {
      padding: 8px;
      text-align: center;
    }
    /* Notification Popup */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #66bb6a;
      color: #fff;
      padding: 1em 1.5em;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 200;
    }
    .notification.show {
      opacity: 1;
    }
    /* Contact Tab Styling */
    #contact {
      padding: 1.5em;
      background: #fff;
      margin: 1em auto;
      max-width: 900px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 5px;
    }
    body.dark-mode #contact {
      background: #333;
      color: #ddd;
    }
    #contact p {
      display: flex;
      align-items: center;
      margin: 0.5em 0;
    }
    #contact p img.icon {
      height: 20px;
      width: 20px;
      margin-right: 0.5em;
    }
    body.dark-mode img.invert {
      filter: invert(1);
    }
    /* Editor container for admin editing */
    .editor-container {
      border: 1px solid #ccc;
      min-height: 200px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <!-- Public tabs -->
      <a data-tab="login" class="tab-link" id="navLogin">Login</a>
      <a data-tab="getStarted" class="tab-link" id="navGetStarted">Get Started</a>
      <a data-tab="contact" class="tab-link" id="navContact">Contact</a>
      <!-- User tabs (hidden initially) -->
      <a data-tab="training" class="tab-link" id="navTraining" style="display:none;">Training</a>
      <a data-tab="tutorials" class="tab-link" id="navTutorials" style="display:none;">Tutorials</a>
      <!-- Admin-only tabs -->
      <a data-tab="admin" class="tab-link" id="navAdmin" style="display:none;">Admin Control</a>
      <a data-tab="questionnaire" class="tab-link" id="navQuestionnaire" style="display:none;">Questionnaire</a>
      <a data-tab="applications" class="tab-link" id="navApplications" style="display:none;">Applications</a>
      <a data-tab="analytics" class="tab-link" id="navAnalytics" style="display:none;">Analytics</a>
      <a id="logoutLink" style="display:none; cursor:pointer; color:#fff; margin-left:1em;">Logout</a>
    </nav>
    <div class="header-right">
      <img src="logo.png" alt="Logo" class="logo">
      <button class="settings-btn" id="settingsBtn">&#9881;</button>
      <div class="settings-popover" id="settingsPopover">
        <label for="modeSwitch">Dark Mode:</label>
        <label class="toggle-switch">
          <input type="checkbox" id="modeSwitch">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </header>

  <!-- Tab Contents -->
  <!-- Login Tab -->
  <div id="login" class="tab-content active">
    <h2>User Login</h2>
    <div class="login-form" id="loginForm">
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <button id="loginBtn">Login</button>
    </div>
  </div>

  <!-- Get Started Tab (Questionnaire Form for Visitors) -->
  <div id="getStarted" class="tab-content">
    <h2>Get Started</h2>
    <div id="questionnaireForm"></div>
    <button id="submitQuestionnaire">Submit</button>
  </div>

  <!-- Training Tab (User View) -->
  <div id="training" class="tab-content">
    <h2>Your Training Plan</h2>
    <div id="displayTraining"></div>
  </div>

  <!-- Tutorials Tab (User View) -->
  <div id="tutorials" class="tab-content">
    <h2>Your Tutorials</h2>
    <div id="displayTutorials"></div>
  </div>

  <!-- Contact Tab -->
  <div id="contact" class="tab-content">
    <h2>Contact</h2>
    <p>
      <img src="phone-icon.png" alt="Phone" class="icon invert">
      <span>Phone: temp</span>
    </p>
    <p>
      <img src="email-icon.png" alt="Email" class="icon invert">
      <span>Email: temp</span>
    </p>
    <p>
      <img src="website-icon.png" alt="Website" class="icon invert">
      <span>Web: temp</span>
    </p>
  </div>

  <!-- Admin Control Tab -->
  <div id="admin" class="tab-content">
    <h2>Admin Control Panel</h2>
    <div class="admin-panel">
      <button id="loadUsers">Load Users</button>
      <div id="userList"></div>
      <h3>Add New User</h3>
      <input type="text" id="newUsername" placeholder="New Username" />
      <input type="text" id="newPassword" placeholder="New Password" />
      <button id="addUser">Add User</button>
    </div>
    <div id="editUser" style="display:none;">
      <h3>Edit User: <span id="editUsernameDisplay"></span></h3>
      <input type="text" id="editUsername" placeholder="Username" /><br>
      <input type="text" id="editPassword" placeholder="Password" /><br>
      <h4>Training Plan</h4>
      <div id="editTrainingEditor" class="editor-container"></div>
      <h4>Tutorials</h4>
      <div id="editTutorialsEditor" class="editor-container"></div>
      <button id="saveEdit">Save Changes</button>
      <button id="cancelEdit">Cancel</button>
    </div>
  </div>

  <!-- Questionnaire Tab for Admin (Edit Questions) -->
  <div id="questionnaire" class="tab-content">
    <h2>Questionnaire Editor</h2>
    <div id="questionList"></div>
    <input type="text" id="newQuestion" placeholder="Enter new question" />
    <button id="addQuestion">Add Question</button>
  </div>

  <!-- Applications Tab for Admin (View Submissions) -->
  <div id="applications" class="tab-content">
    <h2>Questionnaire Submissions</h2>
    <button id="loadApplications">Load Applications</button>
    <div id="applicationsList"></div>
  </div>

  <!-- Analytics Tab for Admin -->
  <div id="analytics" class="tab-content">
    <h2>Analytics</h2>
    <button id="loadAnalytics">Load Analytics</button>
    <div id="analyticsData"></div>
  </div>

  <!-- Notification Popup Container -->
  <div id="notificationContainer"></div>

  <!-- Include jsrsasign -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.23/jsrsasign-all-min.js"></script>
  <script>
    /********************
     * Configuration & Constants
     ********************/
    const SHEET_NAME = "Users"; // for Users data
    const SERVICE_ACCOUNT_EMAIL = "service-account@fitness-coaching-api.iam.gserviceaccount.com";
    const PRIVATE_KEY = `-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCs4H5Hh6v2tsqo
Z6MxKPprhhJr9TTCyvS/H+fL/Az4ngOAxEK0h054osWUa5lUzU7MZUFAszLmUiJZ
qR+AKXqLtCtvbaGiRO7vyvI6zg+8JU3LdyKDxaYoJqD+/ZBI7vN+SCjxWla5V/bG
psJKpMXyTyXMn8hqMxyzQ696LZ1rAiSR1AWosslfw2TCFFzDmZeqH8H3c4G1FZIJ
dYt9+cGZYN7R2bhDWL2aRlXMJJXuC39P8zGojXVdZ+fKv1eiG/fhSRW6ddEJTror
NsCNwIyQnpx1IQkq4lMMsgsOkwSNp56QtLVeTRkvtqsymBdF2fGWtCK+LWsXbIgj
+BribK+NAgMBAAECggEAEQXRAW+fU/2XUoJT/Cr+D5jl1voP7i9obqpwW3Jv/4ol
q6gHrnmVVUUn4e+/ay2FORSuWnXayPmk9sGzv521+qwsy73WmOEjSvrno7k3LO5a
bPLH9ARCEnmNSFaE/t2CnfhyiaN83ybFfrWcc5eqgyvee7nvFOAADznWvVfhBJCJ
qEHV93niS4bHyO42S/dfwJCB9bH0LNuuDwkBo4ucAYzkltATDZdBtFFIH3KLuzgr
Wv99PhJnVxoakrXqHkIyS638m+c1fqztYm2icHkgPFYbLSW3KOWBoU41iGLNioS6
wkB47mAH0W+krRUHM5RXcaRW/7Uus7kXELmlJfCK6QKBgQDiotyiGvDXxhRBTyZv
LJOZNJJ5Ux3mqiSS2HAB5B2B8Yeum1K4KxyqcYOC6JQioqNkH/WBX3vlWcGTATbx
YfgQX6WU7YCByX/CrJ5QChll/YLFIz6mLyjPyPWbt32CiDSSU6AQi4NLaXCJOhlN
4ihkohj3s+jrXoEfHfKZjYGFiQKBgQDDRocxhIAme+EM/MXK/Zzt7d7TCElF/3Pp
MiZO0WsMZ9rZU+LzX7evP1+aCvCc9RGplgIkVl8/66G+DIGNoEIID3y23Xzs31WT
C8o4eelP1TcN3apmczGpeWViuzUgsrydV4+iGiVnaFZLMtn/Fpz4jQlYhRGObwhb
nMxvYztc5QKBgQDAJCc93+1UYgCGJh6Fnps8BlAwQAFXr+P2Az1ivQ0vP6AyrkiB
DzvsXPSMJbaBbrVri5TOrC8UEPaGNT9pgg+Xgh+VlY2fez+vwj0tyoIh773QeMMC
jXTiRJPGAtiLtAIuFGvd2wnjA29/SBxv5U8tkifsyUCtW5/Iy9ED0e5/UQKBgQCp
lpLKulvhECy+7reINwEW0UJ22/dmxxePKnKCePUS7Q7vNx8eZb5MgCkyytV0OpGA
SjrJ/Aj0plrthkbtDITMI0cYOPrJbJwQ/Gg+7AFnx6/sZtoZ52j12evm9taI8zFD
JEwlZ7ecOszWue8Azk68vR+ktMwuetczWNVi1zcy0QKBgCv30zzEtv/uEmW4Uh1d
rsRAnMW53Sx9dpLRu60PFGYO43Dq/CrBDwbbrCjHUNB1l6jaz2IBKHE6s/s3fXjt
6WxeGq4ufJup8vQrIn0l6F/OYxB118Z2G4Iz9F87jcUM6PYOfUwJt1g9CuUmzmSH
7/TjHERfIzWM9qI+/ha6ZlIy
-----END PRIVATE KEY-----\n`;
    const TOKEN_URL = "https://oauth2.googleapis.com/token";
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
    const SPREADSHEET_ID = "1aHnKAI9lNw8-ewOjwKV9XAwt8u10qU2C_OTFSoJCwe8";
    // Ranges for different sheets:
    const USERS_RANGE = `${SHEET_NAME}!A2:D1000`;
    const QUESTIONS_RANGE = "Questions!A2:A1000";
    const APPLICATIONS_RANGE = "Applications!A2:E1000";
    const ANALYTICS_RANGE = "Analytics!A2:D1000";
    // Sheet IDs – update these with your actual gid values:
    const USERS_SHEET_ID = 0;
    const QUESTIONS_SHEET_ID = 1000;      // placeholder; update as needed
    const APPLICATIONS_SHEET_ID = 2000;     // placeholder; update as needed
    const ANALYTICS_SHEET_ID = 3000;        // placeholder; update as needed

    let allUsers = [];
    let currentUser = null;
    let currentEditRow = null;
    let editorTraining, editorTutorials;
    let questionsArray = [];

    /********************
     * Google Sheets API Functions
     ********************/
    async function getAccessToken() {
      const header = { alg: "RS256", typ: "JWT" };
      const now = Math.floor(Date.now() / 1000);
      const claims = {
        iss: SERVICE_ACCOUNT_EMAIL,
        scope: SCOPES,
        aud: TOKEN_URL,
        iat: now,
        exp: now + 3600
      };
      const sHeader = JSON.stringify(header);
      const sPayload = JSON.stringify(claims);
      const privateKey = KEYUTIL.getKey(PRIVATE_KEY);
      const sJWT = KJUR.jws.JWS.sign("RS256", sHeader, sPayload, privateKey);
      const formData = new URLSearchParams();
      formData.append("grant_type", "urn:ietf:params:oauth:grant-type:jwt-bearer");
      formData.append("assertion", sJWT);
      const response = await fetch(TOKEN_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData.toString()
      });
      const data = await response.json();
      return data.access_token;
    }
    async function loadUsers() {
      const token = await getAccessToken();
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${USERS_RANGE}`;
      const response = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
      const data = await response.json();
      allUsers = [];
      if (data.values) {
        data.values.forEach((row, index) => {
          allUsers.push({
            row: index + 2,
            username: row[0],
            password: row[1],
            training: row[2] || "",
            tutorials: row[3] || ""
          });
        });
      }
    }
    async function updateUser(row, userObj) {
      const token = await getAccessToken();
      const range = `${SHEET_NAME}!A${row}:D${row}`;
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=USER_ENTERED`;
      const body = JSON.stringify({ values: [[userObj.username, userObj.password, userObj.training, userObj.tutorials]] });
      const response = await fetch(url, { method: "PUT", headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }, body });
      return await response.json();
    }
    async function appendUser(userObj) {
      const token = await getAccessToken();
      const range = `${SHEET_NAME}!A:D`;
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
      const body = JSON.stringify({ values: [[userObj.username, userObj.password, userObj.training, userObj.tutorials]] });
      const response = await fetch(url, { method: "POST", headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }, body });
      return await response.json();
    }
    async function deleteUserRow(row) {
      const token = await getAccessToken();
      const rowIndex = row - 1;
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}:batchUpdate`;
      const body = JSON.stringify({
        requests: [{
          deleteDimension: {
            range: { sheetId: USERS_SHEET_ID, dimension: "ROWS", startIndex: rowIndex, endIndex: rowIndex + 1 }
          }
        }]
      });
      const response = await fetch(url, { method: "POST", headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }, body });
      return await response.json();
    }
    /********************
     * Applications Functions
     ********************/
    async function loadApplications() {
      const token = await getAccessToken();
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(APPLICATIONS_RANGE)}`;
      const response = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
      const data = await response.json();
      let apps = [];
      if (data.values) {
        data.values.forEach((row, index) => {
          apps.push({
            row: index + 2,
            timestamp: row[0],
            ip: row[1],
            answers: row[2],
            username: row[3],
            deviceId: row[4]
          });
        });
      }
      return apps;
    }
    async function deleteApplication(row) {
      const token = await getAccessToken();
      const rowIndex = row - 1;
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}:batchUpdate`;
      const body = JSON.stringify({
        requests: [{
          deleteDimension: {
            range: { sheetId: APPLICATIONS_SHEET_ID, dimension: "ROWS", startIndex: rowIndex, endIndex: rowIndex + 1 }
          }
        }]
      });
      const response = await fetch(url, { method: "POST", headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }, body });
      return await response.json();
    }
    /********************
     * Analytics Functions
     ********************/
    async function loadAnalytics() {
      const token = await getAccessToken();
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(ANALYTICS_RANGE)}`;
      const response = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
      const data = await response.json();
      let analytics = [];
      if (data.values) {
        data.values.forEach(row => {
          analytics.push({ timestamp: row[0], username: row[1], ip: row[2], deviceId: row[3] });
        });
      }
      return analytics;
    }
    async function appendAnalytics(analyticsObj) {
      const token = await getAccessToken();
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${ANALYTICS_RANGE}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
      const body = JSON.stringify({ values: [[analyticsObj.timestamp, analyticsObj.username, analyticsObj.ip, analyticsObj.deviceId]] });
      const response = await fetch(url, { method: "POST", headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }, body });
      return await response.json();
    }
    /********************
     * Questionnaire Functions (for Questions sheet)
     ********************/
    const QUESTIONS_RANGE = "Questions!A2:A1000";
    const QUESTIONS_SHEET_ID = 1000; // placeholder; update as needed
    async function loadQuestions() {
      const token = await getAccessToken();
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(QUESTIONS_RANGE)}`;
      const response = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
      const data = await response.json();
      questionsArray = [];
      if (data.values) {
        data.values.forEach(row => { questionsArray.push(row[0]); });
      }
      return questionsArray;
    }
    async function updateQuestions(newQuestionsArray) {
      const token = await getAccessToken();
      const range = `Questions!A2:A${newQuestionsArray.length + 1}`;
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=USER_ENTERED`;
      const values = newQuestionsArray.map(q => [q]);
      const body = JSON.stringify({ values });
      const response = await fetch(url, { method: "PUT", headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }, body });
      return await response.json();
    }
    async function deleteQuestion(idx) {
      questionsArray.splice(idx, 1);
      await updateQuestions(questionsArray);
      buildQuestionnaireEditor();
    }
    function moveQuestionUp(idx) {
      if (idx > 0) {
        let temp = questionsArray[idx-1];
        questionsArray[idx-1] = questionsArray[idx];
        questionsArray[idx] = temp;
        updateQuestions(questionsArray).then(() => buildQuestionnaireEditor());
      }
    }
    function moveQuestionDown(idx) {
      if (idx < questionsArray.length - 1) {
        let temp = questionsArray[idx+1];
        questionsArray[idx+1] = questionsArray[idx];
        questionsArray[idx] = temp;
        updateQuestions(questionsArray).then(() => buildQuestionnaireEditor());
      }
    }
    async function buildQuestionnaireEditor() {
      await loadQuestions();
      let output = "<ol>";
      questionsArray.forEach((q, idx) => {
        output += `<li>${q} 
          <button onclick="deleteQuestion(${idx})">Delete</button>
          <button onclick="moveQuestionUp(${idx})" ${idx===0 ? 'disabled' : ''}>Up</button>
          <button onclick="moveQuestionDown(${idx})" ${idx===questionsArray.length-1 ? 'disabled' : ''}>Down</button>
          </li>`;
      });
      output += "</ol>";
      document.getElementById("questionList").innerHTML = output;
    }
    /********************
     * Utility Functions: Get User IP & Device ID
     ********************/
    async function getUserIP() {
      try {
        const response = await fetch("https://api.ipify.org?format=json");
        const data = await response.json();
        return data.ip;
      } catch (e) {
        return "Unknown";
      }
    }
    function getDeviceId() {
      let id = localStorage.getItem("deviceId");
      if (!id) {
        id = 'device-' + Math.random().toString(36).substring(2, 15);
        localStorage.setItem("deviceId", id);
      }
      return id;
    }
    /********************
     * Tab Switching
     ********************/
    document.querySelectorAll('.tab-link').forEach(link => {
      link.addEventListener('click', () => {
        const tabId = link.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        // If the "Get Started" tab is selected, rebuild the questionnaire form.
        if (tabId === "getStarted") {
          buildQuestionnaireForm();
        }
      });
    });
    /********************
     * In-Page Notification
     ********************/
    function showNotification(message) {
      const notification = document.createElement("div");
      notification.className = "notification";
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.classList.add("show"), 100);
      setTimeout(() => {
        notification.classList.remove("show");
        setTimeout(() => document.body.removeChild(notification), 500);
      }, 2000);
    }
    /********************
     * User Login & Display
     ********************/
    document.getElementById('loginBtn').addEventListener('click', async () => {
      await loadUsers();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const user = allUsers.find(u => u.username === username && u.password === password);
      if (user) {
        currentUser = user;
        if (username === "cardio") {
          showNotification("Administrator login successful");
        } else {
          showNotification("Login successful!");
        }
        document.getElementById('navTraining').style.display = 'inline';
        document.getElementById('navTutorials').style.display = 'inline';
        document.getElementById('navContact').style.display = 'inline';
        document.getElementById('navLogin').style.display = 'none';
        document.getElementById('logoutLink').style.display = 'inline';
        if (username === 'cardio') {
          document.getElementById('navAdmin').style.display = 'inline';
          document.getElementById('navQuestionnaire').style.display = 'inline';
          document.getElementById('navApplications').style.display = 'inline';
          document.getElementById('navAnalytics').style.display = 'inline';
        }
        // Record an analytics event
        const ip = await getUserIP();
        const deviceId = getDeviceId();
        const now = new Date().toLocaleString();
        await appendAnalytics({ timestamp: now, username: username, ip: ip, deviceId: deviceId });
        // Inject user-specific content (as HTML)
        document.getElementById('displayTraining').innerHTML = user.training || "<p>No training plan set.</p>";
        document.getElementById('displayTutorials').innerHTML = user.tutorials || "<p>No tutorials set.</p>";
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById('training').classList.add('active');
      } else {
        showNotification("Invalid username or password.");
      }
    });
    document.getElementById('logoutLink').addEventListener('click', () => {
      currentUser = null;
      document.getElementById('navTraining').style.display = 'none';
      document.getElementById('navTutorials').style.display = 'none';
      document.getElementById('navAdmin').style.display = 'none';
      document.getElementById('navQuestionnaire').style.display = 'none';
      document.getElementById('navApplications').style.display = 'none';
      document.getElementById('navAnalytics').style.display = 'none';
      document.getElementById('navLogin').style.display = 'inline';
      document.getElementById('logoutLink').style.display = 'none';
      document.getElementById('displayTraining').innerHTML = "";
      document.getElementById('displayTutorials').innerHTML = "";
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById('login').classList.add('active');
    });
    /********************
     * Get Started (Questionnaire Form for Visitors)
     ********************/
    async function buildQuestionnaireForm() {
      const questions = await loadQuestions();
      let formHtml = "<form id='questionForm'>";
      questions.forEach((q, idx) => {
        formHtml += `<div style="margin-bottom:1em;"><label><strong>Q${idx+1}: ${q}</strong></label><br>
          <textarea name='answer${idx}' rows='3' style='width:100%;'></textarea></div>`;
      });
      formHtml += "</form>";
      document.getElementById('questionnaireForm').innerHTML = formHtml;
    }
    document.getElementById('submitQuestionnaire').addEventListener('click', async () => {
      const form = document.getElementById('questionForm');
      const formData = new FormData(form);
      let answers = {};
      for (let pair of formData.entries()) {
        answers[pair[0]] = pair[1];
      }
      const now = new Date().toLocaleString();
      const ip = await getUserIP();
      const deviceId = getDeviceId();
      await appendApplication({ timestamp: now, ip: ip, answers: JSON.stringify(answers), username: "", deviceId: deviceId });
      showNotification("Your application has been submitted.");
      form.reset();
    });
    /********************
     * Admin Panel Functions for Users
     ********************/
    document.getElementById('loadUsers').addEventListener('click', async () => {
      await loadUsers();
      let output = "<ul>";
      allUsers.forEach(u => {
        output += `<li>${u.username} - ${u.password} 
          <button onclick="editUser(${u.row})">Edit</button> 
          <button onclick="deleteUser(${u.row})">Delete</button></li>`;
      });
      output += "</ul>";
      document.getElementById('userList').innerHTML = output;
    });
    document.getElementById('addUser').addEventListener('click', async () => {
      const newUsername = document.getElementById('newUsername').value;
      const newPassword = document.getElementById('newPassword').value;
      if (newUsername && newPassword) {
        const newUser = { 
          username: newUsername, 
          password: newPassword, 
          training: "<p>Default training plan.</p>", 
          tutorials: "<p>Default tutorials.</p>" 
        };
        await appendUser(newUser);
        showNotification("User added.");
        document.getElementById('newUsername').value = "";
        document.getElementById('newPassword').value = "";
        document.getElementById('loadUsers').click();
      } else {
        showNotification("Please enter both username and password.");
      }
    });
    async function deleteUser(row) {
      if (confirm("Are you sure you want to delete this user?")) {
        await deleteUserRow(row);
        showNotification("User deleted.");
        document.getElementById('loadUsers').click();
      }
    }
    function editUser(row) {
      const user = allUsers.find(u => u.row === row);
      if (user) {
        currentEditRow = row;
        document.getElementById('editUser').style.display = "block";
        document.getElementById('editUsernameDisplay').textContent = user.username;
        document.getElementById('editUsername').value = user.username;
        document.getElementById('editPassword').value = user.password;
        if (!editorTraining) {
          ClassicEditor.create(document.querySelector('#editTrainingEditor'))
            .then(editor => { editorTraining = editor; editorTraining.setData(user.training); })
            .catch(error => { console.error(error); });
        } else {
          editorTraining.setData(user.training);
        }
        if (!editorTutorials) {
          ClassicEditor.create(document.querySelector('#editTutorialsEditor'))
            .then(editor => { editorTutorials = editor; editorTutorials.setData(user.tutorials); })
            .catch(error => { console.error(error); });
        } else {
          editorTutorials.setData(user.tutorials);
        }
      }
    }
    document.getElementById('saveEdit').addEventListener('click', async () => {
      const newUsername = document.getElementById('editUsername').value;
      const newPassword = document.getElementById('editPassword').value;
      const newTraining = editorTraining ? editorTraining.getData() : "";
      const newTutorials = editorTutorials ? editorTutorials.getData() : "";
      if (newUsername && newPassword) {
        const updatedUser = { username: newUsername, password: newPassword, training: newTraining, tutorials: newTutorials };
        await updateUser(currentEditRow, updatedUser);
        showNotification("User updated.");
        document.getElementById('editUser').style.display = "none";
        document.getElementById('loadUsers').click();
      } else {
        showNotification("Please fill in all fields.");
      }
    });
    document.getElementById('cancelEdit').addEventListener('click', () => {
      document.getElementById('editUser').style.display = "none";
    });
    /********************
     * Admin Panel Functions for Questionnaire
     ********************/
    let questionsArray = [];
    async function loadQuestions() {
      const token = await getAccessToken();
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(QUESTIONS_RANGE)}`;
      const response = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
      const data = await response.json();
      questionsArray = [];
      if (data.values) {
        data.values.forEach(row => { questionsArray.push(row[0]); });
      }
      return questionsArray;
    }
    async function updateQuestions(newQuestionsArray) {
      const token = await getAccessToken();
      const range = `Questions!A2:A${newQuestionsArray.length + 1}`;
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=USER_ENTERED`;
      const values = newQuestionsArray.map(q => [q]);
      const body = JSON.stringify({ values });
      const response = await fetch(url, { method: "PUT", headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }, body });
      return await response.json();
    }
    async function buildQuestionnaireEditor() {
      await loadQuestions();
      let output = "<ol>";
      questionsArray.forEach((q, idx) => {
        output += `<li>${q} 
          <button onclick="deleteQuestion(${idx})">Delete</button>
          <button onclick="moveQuestionUp(${idx})" ${idx===0 ? 'disabled' : ''}>Up</button>
          <button onclick="moveQuestionDown(${idx})" ${idx===questionsArray.length-1 ? 'disabled' : ''}>Down</button>
          </li>`;
      });
      output += "</ol>";
      document.getElementById("questionList").innerHTML = output;
    }
    async function deleteQuestion(idx) {
      questionsArray.splice(idx, 1);
      await updateQuestions(questionsArray);
      buildQuestionnaireEditor();
    }
    function moveQuestionUp(idx) {
      if (idx > 0) {
        let temp = questionsArray[idx-1];
        questionsArray[idx-1] = questionsArray[idx];
        questionsArray[idx] = temp;
        updateQuestions(questionsArray).then(() => buildQuestionnaireEditor());
      }
    }
    function moveQuestionDown(idx) {
      if (idx < questionsArray.length - 1) {
        let temp = questionsArray[idx+1];
        questionsArray[idx+1] = questionsArray[idx];
        questionsArray[idx] = temp;
        updateQuestions(questionsArray).then(() => buildQuestionnaireEditor());
      }
    }
    document.getElementById("addQuestion").addEventListener("click", async () => {
      const newQ = document.getElementById("newQuestion").value;
      if (newQ) {
        const token = await getAccessToken();
        const range = "Questions!A:A";
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
        const body = JSON.stringify({ values: [[newQ]] });
        await fetch(url, { method: "POST", headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }, body });
        showNotification("Question added.");
        document.getElementById("newQuestion").value = "";
        buildQuestionnaireEditor();
      } else {
        showNotification("Please enter a question.");
      }
    });
    /********************
     * Admin Panel Functions for Applications
     ********************/
    async function loadApplications() {
      const token = await getAccessToken();
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(APPLICATIONS_RANGE)}`;
      const response = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
      const data = await response.json();
      let apps = [];
      if (data.values) {
        data.values.forEach((row, index) => {
          apps.push({
            row: index + 2,
            timestamp: row[0],
            ip: row[1],
            answers: row[2],
            username: row[3],
            deviceId: row[4]
          });
        });
      }
      return apps;
    }
    document.getElementById("loadApplications").addEventListener("click", async () => {
      const apps = await loadApplications();
      let output = "<ul>";
      apps.forEach(app => {
        output += `<li><strong>${app.timestamp}</strong> - IP: ${app.ip} - Answers: ${app.answers} 
          <button onclick="deleteApplication(${app.row})">Delete</button></li>`;
      });
      output += "</ul>";
      document.getElementById("applicationsList").innerHTML = output;
    });
    async function deleteApplication(row) {
      const token = await getAccessToken();
      const rowIndex = row - 1;
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}:batchUpdate`;
      const body = JSON.stringify({
        requests: [{
          deleteDimension: {
            range: { sheetId: APPLICATIONS_SHEET_ID, dimension: "ROWS", startIndex: rowIndex, endIndex: rowIndex + 1 }
          }
        }]
      });
      await fetch(url, { method: "POST", headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }, body });
      showNotification("Application deleted.");
      document.getElementById("loadApplications").click();
    }
    /********************
     * Admin Panel Functions for Analytics
     ********************/
    document.getElementById("loadAnalytics").addEventListener("click", async () => {
      const analytics = await loadAnalytics();
      let output = "<table><tr><th>Timestamp</th><th>Username</th><th>IP</th><th>Device ID</th></tr>";
      analytics.forEach(a => {
        output += `<tr><td>${a.timestamp}</td><td>${a.username}</td><td>${a.ip}</td><td>${a.deviceId}</td></tr>`;
      });
      output += "</table>";
      document.getElementById("analyticsData").innerHTML = output;
    });
    /********************
     * Utility Functions: Get User IP & Device ID
     ********************/
    async function getUserIP() {
      try {
        const response = await fetch("https://api.ipify.org?format=json");
        const data = await response.json();
        return data.ip;
      } catch (e) {
        return "Unknown";
      }
    }
    function getDeviceId() {
      let id = localStorage.getItem("deviceId");
      if (!id) {
        id = 'device-' + Math.random().toString(36).substring(2, 15);
        localStorage.setItem("deviceId", id);
      }
      return id;
    }
  </script>
</body>
</html>
